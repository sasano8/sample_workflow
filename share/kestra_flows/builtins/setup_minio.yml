id: setup_minio
namespace: tutorial.builtin

tasks:
  - id: run_mc
    type: io.kestra.plugin.scripts.shell.Commands
    runner: DOCKER
    docker:
      image: minio/mc
      entryPoint:
        - ""
      networkMode: "internal"
    env:
      AWS_ACCESS_KEY_ID: "{{ kv('AWS_ACCESS_KEY_ID') }}"
      AWS_SECRET_ACCESS_KEY: "{{ kv('AWS_SECRET_ACCESS_KEY') }}"
      AWS_REGION: "{{ kv('AWS_REGION') }}"
      S3_ALIAS: "myminio"
    commands:
      # - "echo $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY $AWS_REGION"
      - "/usr/bin/mc alias set $S3_ALIAS http://minio:9000 $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY"
      - "/usr/bin/mc ls $S3_ALIAS"
      - "/usr/bin/mc rm -r --force $S3_ALIAS/warehouse || true"
      - "/usr/bin/mc mb $S3_ALIAS/warehouse"  # minio
      - "/usr/bin/mc anonymous set public $S3_ALIAS/warehouse"  # public にする
